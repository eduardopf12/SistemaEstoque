@model IEnumerable<Estoque.Models.Auditoria>

@{
    ViewData["Title"] = "Auditoria do Sistema";
}

<!-- TÍTULO -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-0">📊 Auditoria do Sistema</h2>
        <span class="text-muted">Registro de ações realizadas no sistema</span>
    </div>
</div>

<!-- TABELA -->
<div class="card border-0 shadow-sm">
    <div class="card-header fw-bold">
        📋 Registros de Auditoria
    </div>

    <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Data</th>
                    <th>Usuário</th>
                    <th>Ação</th>
                    <th>Entidade</th>
                    <th>Detalhes</th>
                    <th>Motivo</th>
                </tr>
            </thead>

            <tbody>
                @if (Model.Any())
                {
                    foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.Data.ToString("dd/MM/yyyy HH:mm")</td>

                            <td class="fw-semibold">
                                @item.Usuario
                            </td>

                            <td>
                                <span class="badge
                                            @(item.Acao == "CREATE" ? "bg-success" :
                                                                            item.Acao == "EDIT" ? "bg-warning text-dark" :
                                                                            item.Acao == "DELETE" ? "bg-danger" :
                                                                                                    "bg-secondary")">
                                    @item.Acao
                                </span>
                            </td>

                            <td>@item.Entidade</td>

                            <!-- BOTÃO VER -->
                            <td>
                                <button class="btn btn-sm btn-outline-info"
                                        data-bs-toggle="modal"
                                        data-bs-target="#detalhesModal"
                                        data-detalhes="Produto: @item.Produto | Tipo: @item.Tipo | Quantidade: @item.Quantidade | Patrimônio: @item.Patrimonio"
                                        data-imagem="@item.FotoAuditoria">
                                    👁️ Ver
                                </button>


                            </td>

                            <td class="fw-semibold text-danger">
                                @item.Motivo
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            Nenhum registro encontrado.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL DETALHES -->
<div class="modal fade" id="detalhesModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">📄 Detalhes da Auditoria</h5>
                <button type="button"
                        class="btn-close btn-close-white"
                        data-bs-dismiss="modal"></button>
            </div>

            <!-- CORPO DO MODAL -->
            <div class="modal-body d-flex flex-column align-items-center">

                <!-- IMAGEM -->
                <div class="mb-3 w-100 text-center">
                    <img id="modalImagem"
                         class="img-fluid rounded shadow d-none"
                         style="max-height:250px;"
                         alt="Imagem do produto">
                </div>

                <!-- DETALHES -->
                <ul class="list-group w-100" id="modalDetalhesList"></ul>

            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Fechar
                </button>
            </div>

        </div>
    </div>
</div>


@section Scripts {
  
<script>
    const modal = document.getElementById('detalhesModal');

    modal.addEventListener('show.bs.modal', function (event) {

        const button = event.relatedTarget;
        if (!button) return;

        const detalhes = button.dataset.detalhes;
        const imagemNome = button.dataset.imagem;

        const lista = document.getElementById('modalDetalhesList');
        const img = document.getElementById('modalImagem');

        // Limpa
        lista.innerHTML = '';
        img.classList.add('d-none');
        img.src = '';

        // Detalhes
        if (detalhes) {
            detalhes.split('|').forEach(item => {
                const [k, v] = item.split(':');
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `<strong>${k.trim()}:</strong> ${v?.trim() ?? ''}`;
                lista.appendChild(li);
            });
        }

        // Imagem
        if (imagemNome && imagemNome.trim() !== '') {
                img.src = `/uploads/auditoria/${imagemNome}`;

            img.classList.remove('d-none');

            img.onerror = () => {
                console.warn('Imagem não encontrada:', img.src);
                img.classList.add('d-none');
            };
        }
    });
</script>
}



